


```{r}

dat <- readRDS('../../data/all_sim_m2m.rds')
# There is also m2a
  
dat <- dat$as_wide() %>% 
  select(-sim_opti3)

bn <- bestNormalize::bestNormalize(dat$sim_ratings)

hist(bn$x.t)

dat <- dat %>% 
  mutate(sim_ratings_norm = bn$x.t)
  
```


```{r}

# Fix the random numbers by setting the seed 
# This enables the analysis to be reproducible 
set.seed(123)

# Put 3/4 of the data into the training set 
data_split <- initial_split(dat, prop = 3/4)

# Create dataframes for the two sets:
train_data <- training(data_split) 
test_data <- testing(data_split)

```


```{r}


lm_1 <- lm(sim_ratings ~ sim_diffed + sim_harmcore + sim_ncdintioi + 
             sim_ngram_ioi_class_dist1 + sim_ngram_ioi_class_dist2 + 
             sim_ngrtvers + sim_ngrukko1 + sim_ngrukko2 + sim_ngrukkon + sim_rawed + sim_rhytfuzz, data = train_data)


lm_2 <- lm(sim_ratings_norm ~ sim_diffed + sim_harmcore + sim_ncdintioi + 
             sim_ngram_ioi_class_dist1 + sim_ngram_ioi_class_dist2 + 
             sim_ngrtvers + sim_ngrukko1 + sim_ngrukko2 + sim_ngrukkon + sim_rawed + sim_rhytfuzz, data = train_data)

```

```{r}


test_data <- test_data %>% 
  mutate(pred = predict(lm_1, newdata = test_data),
         pred2 = predict(lm_2, newdata = test_data))


```

```{r}

lm_reg <- lm(sim_ratings ~ pred, data = test_data)

```

```{r}

summary(lm_reg)

```

```{r}

lm_reg2 <- lm(sim_ratings_norm ~ pred, data = test_data)

```

```{r}

summary(lm_reg2)

```


```{r}

Metrics::rmse(test_data$sim_ratings, test_data$pred)

Metrics::rmse(test_data$sim_ratings, test_data$pred2)


```


```{r}


bb_mod_dat <- 
  train_data %>% 
        mutate_if(is.numeric, ~ round(1000 * .x)) %>%
        mutate(sim_ratings_complement = 1000 - sim_ratings)


bb_mod <- 
  gamlss::gamlss(data = bb_mod_dat, 
                 formula = cbind(sim_ratings, sim_ratings_complement) ~ 1 + sim_diffed + sim_harmcore + sim_ncdintioi +
                  sim_ngram_ioi_class_dist1 + sim_ngram_ioi_class_dist2 +
                  sim_ngrtvers + sim_ngrukko1 + sim_ngrukko2 + sim_ngrukkon + 
                  sim_rawed + sim_rhytfuzz,
                family = gamlss.dist::BB(),
                control = gamlss::gamlss.control(trace = F, save = T))

```


```{r}


bb_mod_dat_test <- 
  test_data %>% 
        select(-c(pred, pred2)) %>% 
        mutate_if(is.numeric, ~ round(1000 * .x)) %>%
        mutate(sim_ratings_complement = 1000 - sim_ratings)

bb_mod_dat_test <- bb_mod_dat_test %>% 
  mutate(bb_pred = stats::predict(bb_mod, type = "response",
                     newdata = bb_mod_dat_test,
                     data = bb_mod_dat) * 1000)

```


```{r}

lm_reg3 <- lm(sim_ratings ~ bb_pred, data = bb_mod_dat_test)


summary(lm_reg3)

```


```{r}

Metrics::rmse(bb_mod_dat_test$sim_ratings, bb_mod_dat_test$bb_pred)/1000


```

